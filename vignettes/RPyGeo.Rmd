---
title: "RPyGeo"
author: "Marc Becker and Fabian Polakowski"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

**RPyGeo** establishes an interface to the geoprocessing tools of ArcMap in R.
Since ArcMap only provides a Python API for a low-level access of its geoalgorithms, **RPyGeo** establishes a tunnel to Python via the **reticulate** package.
<!-- what do you want to say with the next three sentences? -->
RPyGeo is not just a wrapper package for ArcPy.
It aims to create an environment, in which the user can perform ArcGIS and R functions on the same dataset in a contiguous workflow. 
It should not be necessary to touch Python or ArcGIS. 

## ArcPy

<!-- again not really sure what you want to say with the subsequent paragraph, maybe we should talk in person-->
ArcPy is a Python side-package that provides the user with Python access to almost any geoprocessing tools in ArcGIS <!-- source! -->. 
ArcPy is organized into modules, which are Python files with functions and classes. The ArcPy main module has several hundred functions and classes. 
It is supported by various modules like the `data access` module or extensions like the `spatial analysis` extension, which increase the number of functions and classes further. 

The ArcPy functions are essentially wrapper for the ArcGIS geoprocessing tools and other scripting tasks.  
The ArcPy classes are blueprints for any kind of object in ArcPy. For example, `Point` and `Raster` are classes to describe geographic data. ArcPy classes are also used to set geoprocessing environment settings (e.g. `workspace` or `extent`).

In order to use RPyGeo you need to install ArcMap or ArcGIS Pro. ArcPy is included in a full ArcGIS installation. 

## Tutorial

This tutorial requires the following packages to be installed and attached:

```{r}
library("RpyGeo")
library("spData")
library("sf")
library("raster")
```

<!-- well, this is an "artificial" dem, why don't you just use data(dem, package = "RQGIS")-->
We will use the `elev` and `nz` datasets from the **spData** package to demonstrate both raster and vector operations.
To make these datasets available for the subsequent ArcMap geoprocessing, we have to export them.
Therefore, we save `nz` and `elev` to a temporary directory.

```{r, eval = FALSE}
data(elev, nz, package = "spData")
writeRaster(elev, file.path(tempdir(), "elev.tif"), format = "GTiff")
st_write(nz, file.path(tempdir(), "nz.shp"))
```

### Load ArcPy module and build environment

ArcPy will only work with the Python binary that comes with the ArcGIS installation.
`rpygeo_build_env()` will initialize a Python session using the correct Python binary and also attaches the `arcpy` library.
If this Python binary is not installed in the default location (`C:/Python27` in the case of ArcMap and `C:/Program Files/ArcGIS/Pro/bin/Python/envs/arcgispro-py3` in the case of ArcGIS Pro), one can set it explicitly with the `path` parameter. 

```{r, eval = FALSE}
arcpy <- rpygeo_build_env(workspace = tempdir(),
                          overwrite = TRUE,
                          extensions = "Spatial")
```

`rpygeo_build_env()` lets the user also specify and enable further common settings.
For instance, setting `overwrite` to `TRUE` lets the user overwrite an already existing spatial object with the output created by an ArcPy geoalgorithm.
`Extensions` enable the various available extensions whose availability is dependent on the purchased ArcGIS license.
Here, we have enabled the Spatial Analysis extension.
The `workspace` parameter defines the default directory in which to look for spatial objects and also where to save the outputs of geoprocessing functions. 
Note that the workspace can be a directory or a ESRI file geodatabase.^[If you work with large raster files we would recommend to use a directory, because it takes a long time to load raster datasets from a file geodatabase into an R session.]

<!-- Never heard of the scratch workspace, what is it? -->
A scratch workspace is automatically created inside the workspace. 
ArcPy stores temporary files in this directory.
You can change the scratch directory with the parameter `scratch_workspace`.

### Use ArcPy functions

ArcPy functions can be accessed via the `$` operator. You can take advantage of the code completion feature of RStudio. After typing the `$` operator all functions of the ArcPy module are listed. Parameters are also autocompleted. 

```{r, eval = FALSE}
env$Slope_3d(in_raster = "elev.tif", out_raster = "slope.tif")
```

We created a slope raster file from the elevation raster file. Note that `slope.tif` is written to the workspace directory and is not automatically loaded into the R session.

We can use the pipe operator `%>%` to chain ArcPy function together. 

```{r, eval = FALSE}
arcpy$Dissolve_management(in_features = "nz.shp", 
                        out_feature_class = "nz_island.shp", 
                        dissolve_field = "Island") %>%
  arcpy$PolygonToLine_management("nz_border.shp")
```

In this example the `nz.shp` shapefile is dissolved on the `Island` field and then the polygons are converted to polylines.

![NZ Workflow.](nz.png){width=100%}

### Modules and extensions

RPyGeo imports all functions and classes of the available ArcPy modules and extensions. You can access all geoprocessing tools found in the standard toolboxes with a single `$` operator. To access the functions and classes of another module, you have to use a second `$` operator to specify the module.

```{r, eval=FALSE}
arcpy$sa$Slope(in_raster = "elev.tif")
```

The `Slope` function of the Spatial Analysis extension is located under `sa`. 

### Help files

Help files for each ArcPy function can be accessed with the function `rpygeo_help`.

```{r, eval=FALSE}
rpygeo_help(arcpy$Slope_3d)
```

The help file is displayed in the viewer pane of RStudio. If you use RPyGeo in another IDE, the help file is displayed in the default browser.


### Search for ArcPy function

If you do not know the name of the ArcPy function or class, the `rpygeo_search` function can be used. The search term can be plain text or a regular expression.

```{r, eval=FALSE}
rpygeo_search(search_term = "3d", module = arcpy)
```

In this example all functions of the ArcPy main module, that contain the term `3d` in their name are returned. 

If we want to search in another module we have to change the `module` parameter.


```{r, eval=FALSE}
rpygeo_search(search_term = "Classify", module = arcpy$sa)
```

### Load output file into R Session

The output of an ArcPy function can be directly loaded into the R session with the `rpygeo_load` function.

```{r, eval=FALSE}
arcpy$Slope_3d(in_raster = "elev.tif", out_raster = "slope.tif") %>%
  rpygeo_load() -> slope
```

The slope raster is loaded as a `raster` object into the R session.

###  Save files

Some functions have no parameter to specify an output file. Instead they return an object and a temporary file is saved to the workspace. For example, the `sa$Aspect` function returns a `Raster` object and writes a temporary Arc/Info Binary Grid file to the workspace. 

```{r, eval=FALSE}
arcpy$sa$Aspect(in_raster("elev.tif")) %>%
  rpygeo_save("aspect.tif")
```

### Map algebra

Map algebra expressions can be used in RPyGeo with special operators. The four basic calculus functions are implemented as `%rpygeo_+%`, `%rpygeo_-%`, `%rpygeo_*%`, `%rpygeo_/%`. 

```{r, eval=FALSE}
ras <- arcpy$sa$Raster("elev.tif") 

ras %rpygeo_+% 2 %>%
  rpygeo_save("elev_2.tif")
```

In this example we created a raster object from the elevation raster. Then we added 2 to each pixel value. For map algebra the `rpygeo_save` function is very handy, because the output of map algebra is always a temporary file. 

## Conclusion

We hope this tutorial helped you to get familiar with RPyGeo. ArcGIS offers many functions and classes and therefore it is not possible to test them all in RPyGeo. If you find any bugs please report them at <https://github.com/fapola/RPyGeo/>.
